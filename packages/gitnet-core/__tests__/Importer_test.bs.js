// Generated by BUCKLESCRIPT VERSION 4.0.14, PLEASE EDIT WITH CARE
'use strict';

var Jest = require("@glennsl/bs-jest/src/jest.js");
var Json = require("@glennsl/bs-json/src/Json.bs.js");
var List = require("bs-platform/lib/js/list.js");
var $$Array = require("bs-platform/lib/js/array.js");
var Block = require("bs-platform/lib/js/block.js");
var Curry = require("bs-platform/lib/js/curry.js");
var Js_dict = require("bs-platform/lib/js/js_dict.js");
var Js_json = require("bs-platform/lib/js/js_json.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Json_decode = require("@glennsl/bs-json/src/Json_decode.bs.js");
var Graph$Reason = require("../src/Graph/Graph.bs.js");
var RList$Rationale = require("rationale/src/RList.js");
var Option$Rationale = require("rationale/src/Option.js");
var SecureRandomString = require("@ncthbrt/re-secure-random-string/src/SecureRandomString.bs.js");

function factDecoder(p, json, baseId, resourceId) {
  var match = Js_json.classify(json);
  if (typeof match === "number") {
    return /* record */[
            /* id */undefined,
            /* p */p,
            /* baseId */baseId,
            /* resourceId */resourceId,
            /* v : String */Block.__(0, ["Couldn't find"])
          ];
  } else {
    switch (match.tag | 0) {
      case 0 : 
          return /* record */[
                  /* id */undefined,
                  /* p */p,
                  /* baseId */baseId,
                  /* resourceId */resourceId,
                  /* v : String */Block.__(0, [Json_decode.string(json)])
                ];
      case 2 : 
          return /* record */[
                  /* id */"sddf",
                  /* p */p,
                  /* baseId */baseId,
                  /* resourceId */resourceId,
                  /* v : String */Block.__(0, [Json_decode.field("value", Json_decode.string, json)])
                ];
      case 3 : 
          return /* record */[
                  /* id */undefined,
                  /* p */p,
                  /* baseId */baseId,
                  /* resourceId */resourceId,
                  /* v : Array */Block.__(1, [$$Array.map(Json_decode.string, match[0])])
                ];
      default:
        return /* record */[
                /* id */undefined,
                /* p */p,
                /* baseId */baseId,
                /* resourceId */resourceId,
                /* v : String */Block.__(0, ["Couldn't find"])
              ];
    }
  }
}

function filterArray(filter, ar) {
  return $$Array.of_list(Curry._1(filter, $$Array.to_list(ar)));
}

function propertyDecoder(json, baseId, resourceId) {
  var filteredFactKeys = /* :: */[
    "templates",
    /* [] */0
  ];
  var thing0 = Option$Rationale.toExn("Parse Error", Js_json.decodeObject(json));
  var toFact = function (id) {
    var _value = Option$Rationale.toExn("Parse Error", Js_dict.get(thing0, id));
    return factDecoder(id, _value, baseId, resourceId);
  };
  var ar = Object.keys(thing0);
  var param = $$Array.to_list(ar);
  var nonTemplateKeys = $$Array.of_list(RList$Rationale.without(filteredFactKeys, param));
  return $$Array.map(toFact, nonTemplateKeys);
}

function removeIfInList(list, fn) {
  return List.filter((function (e) {
                var __x = Curry._1(fn, e);
                return !RList$Rationale.contains(__x)(list);
              }));
}

function decodeBase(json) {
  var entries = $$Array.to_list(Js_dict.entries(Option$Rationale.toExn("Parse Error", Js_json.decodeObject(json))));
  var baseId = Json_decode.field("baseId", Json_decode.string, json);
  var resourceId = Json_decode.field("baseId", Json_decode.string, json);
  return $$Array.of_list(List.map((function (param) {
                    return /* record */[
                            /* id */param[0],
                            /* facts */propertyDecoder(param[1], baseId, resourceId),
                            /* templates : array */[]
                          ];
                  }), removeIfInList(/* :: */[
                        "baseId",
                        /* :: */[
                          "resourceId",
                          /* [] */0
                        ]
                      ], (function (param) {
                          return param[0];
                        }))(entries)));
}

function decode(json) {
  return Belt_Array.concatMany(Json_decode.array(decodeBase, json));
}

var Importer1 = /* module */[
  /* factDecoder */factDecoder,
  /* filterArray */filterArray,
  /* propertyDecoder */propertyDecoder,
  /* removeIfInList */removeIfInList,
  /* decodeBase */decodeBase,
  /* decode */decode
];

function toGraph(things) {
  var valueToValues = function (v) {
    if (v.tag) {
      return v[0];
    } else {
      return /* array */[v[0]];
    }
  };
  return Graph$Reason.from_facts($$Array.to_list(Belt_Array.concatMany(Belt_Array.concatMany($$Array.of_list(List.map((function (thing) {
                                    return $$Array.map((function (fact) {
                                                  return $$Array.map((function (value) {
                                                                var match = Option$Rationale.isSome(fact[/* id */0]);
                                                                return /* record */[
                                                                        /* id */Option$Rationale.$$default(SecureRandomString.genSync(8, true, /* () */0), fact[/* id */0]),
                                                                        /* subjectId */thing[/* id */0],
                                                                        /* propertyId */fact[/* p */1],
                                                                        /* value : String */Block.__(1, [value]),
                                                                        /* idIsPublic */match ? true : false,
                                                                        /* baseId */fact[/* baseId */2],
                                                                        /* resourceId */fact[/* resourceId */3]
                                                                      ];
                                                              }), valueToValues(fact[/* v */4]));
                                                }), thing[/* facts */1]);
                                  }), $$Array.to_list(things)))))));
}

var value = Json.parseOrRaise("\n      [\n        {\n        \"resourceId\": \"111\",\n        \"baseId\":\"1\",\n        \"n-fred\": {\n          \"p-name\": \"Fred\",\n          \"p-test\": [\"sdf\", \"sdfsdf\", \"sdfsdf\"],\n          \"p-description\": {\"id\": \"sdf\", \"value\": \"sdffsd\"}\n        }\n      },\n      {\n        \"resourceId\": \"111\",\n        \"baseId\":\"2\",\n        \"n-george\": {\n          \"p-name\": \"George\",\n          \"p-friend\": \"n-jeremy\",\n          \"p-test\": [\"sdf\", \"sdfsdf\", \"sdfsdf\"],\n          \"p-description\": {\"id\": \"sdf\", \"value\": \"sdffsd\"}\n        },\n        \"n-jeremy\": {\n          \"p-name\": \"George\",\n          \"p-test\": [\"sdf\", \"sdfsdf\", \"sdfsdf\"],\n          \"p-description\": {\"id\": \"sdf\", \"value\": \"sdffsd\"}\n        }\n      }]\n   ");

describe("#to_json", (function () {
        return Jest.test("works", (function (param) {
                      var foo = Graph$Reason.to_json(toGraph(Belt_Array.concatMany(Json_decode.array(decodeBase, value))));
                      console.log(foo);
                      return Jest.Expect[/* toEqual */12](true, Jest.Expect[/* expect */0](true));
                    }));
      }));

exports.Importer1 = Importer1;
exports.toGraph = toGraph;
exports.value = value;
/* value Not a pure module */
